{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="/static/styles/pages/profile.css">
<link rel="stylesheet" href="/static/styles/header.css">
<header id="header">
  <a class="logo" href="{{base}}/">
    <img class="logo" src="{{base}}/static/img/p215-circle.svg" >
  </a>
  <menu class="menu">
    <li class="mobileHidden">
      <a href="https://experiencethehope.com/teaching" target="_blank">
        Teachings
      </a>
    </li>
    <li class="mobileHidden">
      <a href="https://experiencethehope.com/equipping" target="_blank">
        Equipping
      </a>
    </li>
    <li class="mobileHidden">
      <a href="https://messaging.subsplash.com/25FXCW/auth" target="_blank">
        Messaging
      </a>
    </li>
  </menu>

  <div class="buttons">
    <button class="profileButton" onclick="toggleModal('#profileNav')">
      {{user.nameShort}}
    </button>
  </div>
</header>

<dialog id="profileNav">
  <menu>
    <li>
      <a href="{{base}}/">
        Home
      </a>
    </li>
    <li>
      <a href="{{base}}/signout">
        Sign Out
      </a>
    </li>
  </menu>
</dialog>

<div id="profileScroll">
  <div class="profileHeader">
    <div class="profileAvatar">{{user.nameShort}}</div>
    <div class="profileHeaderInfo">
      <h1>{{user.name}}</h1>
      <p>{{user.email}}</p>
    </div>
  </div>

  <div id="profileContent">
    <div class="profileCard">
      <h2>Profile Info</h2>
      {% include "profile/form.html" %}
    </div>

    <div class="profileCard">
      <h2>Features</h2>
      {% include "profile/featureForm.html" %}
    </div>
  </div>

  {% include "footer.html" %}
</div>

<script>
  {% include "scripts/inputs.js" %}

  function formSnapshot(form) {
    return new FormData(form);
  }

  function snapshotsEqual(a, b) {
    const aEntries = [...a.entries()].sort().toString();
    const bEntries = [...b.entries()].sort().toString();
    return aEntries === bEntries;
  }

  function initFormDirtyTracking(form) {
    const btn = form.querySelector('button[type="submit"]');
    if (!btn) return;
    const baseline = formSnapshot(form);
    function update() {
      btn.disabled = snapshotsEqual(baseline, formSnapshot(form));
    }
    form.addEventListener("input", update);
    form.addEventListener("change", update);
  }

  function initAllForms() {
    document.querySelectorAll(".profileCard form").forEach(initFormDirtyTracking);
  }

  window.addEventListener("load", initAllForms);
  document.addEventListener("htmx:afterSwap", (e) => {
    const form = e.target.closest && e.target.closest("form") || e.target.querySelector && e.target.querySelector("form");
    if (form) initFormDirtyTracking(form);
  });
</script>

{% endblock %}
